@model FacePalm.Models.Post
@{ICollection<FacePalm.Models.Comment> comments = Model.Comments.ToList();}
<div>
    <h4>@ViewBag.numeCreator</h4>
    <dl class="dl-horizontal">
        <dt>
            @Html.DisplayNameFor(model => model.Date)
        </dt>
        <dd>
            @Html.DisplayFor(model => model.Date)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.ImageDescription)
        </dt>

        <dd>
            @if (Model.ImageDescription == null)
            {
                <p>wtf?</p>
            }
            @Html.DisplayFor(model => model.ImageDescription)
        </dd>
        @if (Model.ImagePath != null)
        {
            <dd>
                <img src="@Url.Content(Model.ImagePath)" class="img-responsive" />
            </dd>
        }

    </dl>


    @if ((ViewBag.afisareButoane == true && Model.UserId == ViewBag.CurrentUser) || ViewBag.esteAdmin)
    {

        
        @Html.HttpMethodOverride(HttpVerbs.Delete)
        <button class="btn btn-success" type="submit"><a href="/Post/Delete/@Model.PostId">Delete post</a></button>
    }
    @if (Model.UserId == ViewBag.CurrentUser || ViewBag.isFriend)
    {
        <button type="button" class="addCommentPostInfo btn btn-sm btn-outline-secondary">Add comment</button>
    }

</div>
<div>

    @foreach (var comm in comments)
    {
        <div>
            @Html.Partial("CommentInfo", comm)
        </div>
        <br />
    }
</div>

<script>
    $(document).ready(function () {
        $(".addCommentPostInfo").click(function (event) {
            event.stopPropagation();
            event.stopImmediatePropagation();
            var textArea = $('<textarea rows = "4" cols = "100%" id = "comment" class="d-flex justify-content-between align-items-center"/>');
            $(this).parent().append(textArea);
            var $submitButton = $('<button type="button" class="submitCommentBtnPostInfo btn btn-sm btn-outline-secondary">Add</button>');
            $submitButton.on('click', function (e) {
                var textAreaValue = $(this).parent().children().eq(5).val();
                var userId = '@ViewBag.CurrentUser';
                var comment = {
                    PostId: @Model.PostId,
                    UserId: userId,
                    Content: textAreaValue,
                    Date: new Date($.now())
                };
                var thisButton = $(this);
                var thisTextArea = $(this).parent().children().eq(5);
                $.ajax({
                    type: 'POST',
                    dataType: 'json',
                    data: JSON.stringify({ "comment": comment }),
                    url: '/Comment/New',
                    cache: false,
                    contentType: 'application/json; charset=utf-8',
                    success: function (serverAnswer) {
                        if (serverAnswer.success) {
                            thisButton.remove();
                            thisTextArea.remove();
                            //Something to add the comm in the list
                            location.reload();
                        }
                        else {
                            alert("The request couldn't be processed, please try again :(")
                        }
                    },
                    error: function () {
                        alert("error");
                    }
                });
            });
            $(this).parent().append($submitButton);
            $(this).hide();
        });

    });
</script>
